<!DOCTYPE html>
<html lang="en" class="dark:bg-gray-900 dark:text-gray-100">
<head>
  <meta charset="UTF-8">
  <title>Log4Lab ‚Äî Live Structured Logs</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke-linecap='round' stroke-linejoin='round'><path d='M4 3v18h14' stroke='%234F46E5' stroke-width='3'/><circle cx='14' cy='10' r='5' stroke='%236366F1' stroke-width='2' fill='white'/><line x1='18' y1='14' x2='21' y2='17' stroke='%236366F1' stroke-width='2'/></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
  <!-- Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
  <script>
    if (localStorage.theme === 'dark' ||
        (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors">
  <div class="max-w-6xl mx-auto p-6">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-3xl font-bold">Log4Lab <span class="text-sm font-light">(Live)</span></h1>
      <div class="flex space-x-2">
        <a href="/runs" class="px-3 py-1 rounded border text-sm bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700">
          üìã Runs Index
        </a>
        <a href="https://github.com/tlamadon/log4lab" target="_blank" class="px-3 py-1 rounded border text-sm bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700">
          <svg class="inline-block w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
          </svg>
          GitHub
        </a>
        <button id="printBtn"
          class="px-3 py-1 rounded border text-sm bg-green-100 dark:bg-green-900 hover:bg-green-200 dark:hover:bg-green-800">
          üñ®Ô∏è Print
        </button>
      </div>
    </div>

    <div class="flex space-x-4 mb-4 items-center flex-wrap">
      <div>
        <label class="block text-sm font-medium">Level</label>
        <select id="levelFilter" class="border rounded px-2 py-1 dark:bg-gray-800 dark:border-gray-700">
          <option value="">All</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium">Section</label>
        <input id="sectionFilter" type="text"
               class="border rounded px-2 py-1 dark:bg-gray-800 dark:border-gray-700"
               placeholder="e.g. train" />
      </div>

      <div>
        <label class="block text-sm font-medium">Group</label>
        <input id="groupFilter" type="text"
               class="border rounded px-2 py-1 dark:bg-gray-800 dark:border-gray-700"
               placeholder="e.g. experiment1" />
      </div>

      <div>
        <label class="block text-sm font-medium">Run Name</label>
        <div class="flex items-center gap-2">
          <input id="runNameFilter" type="text"
                 class="border rounded px-2 py-1 dark:bg-gray-800 dark:border-gray-700"
                 placeholder="e.g. my_experiment" />
          <button id="liveRunBtn"
                  class="hidden px-2 py-1 rounded text-xs font-medium bg-red-500 text-white hover:bg-red-600 flex items-center gap-1 animate-pulse"
                  title="Jump to the most recent run">
            <span class="w-2 h-2 bg-white rounded-full"></span>
            Live
          </button>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium">Run ID</label>
        <input id="runIdFilter" type="text"
               class="border rounded px-2 py-1 dark:bg-gray-800 dark:border-gray-700"
               placeholder="e.g. abc123" />
      </div>

      <div>
        <label class="block text-sm font-medium">Time Range</label>
        <select id="timeFilter" class="border rounded px-2 py-1 dark:bg-gray-800 dark:border-gray-700">
          <option value="">All Time</option>
          <option value="60">Last 1 minute</option>
          <option value="300">Last 5 minutes</option>
          <option value="600">Last 10 minutes</option>
          <option value="1800">Last 30 minutes</option>
          <option value="3600">Last 1 hour</option>
          <option value="21600">Last 6 hours</option>
          <option value="86400">Last 24 hours</option>
        </select>
      </div>

      <button id="clearFilters"
        class="bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 dark:hover:bg-gray-700 px-3 py-1 rounded mt-5">
        Clear
      </button>

      <button id="sortToggle"
        class="bg-blue-100 dark:bg-blue-900 hover:bg-blue-200 dark:hover:bg-blue-800 px-3 py-1 rounded mt-5 text-sm">
        ‚¨ÜÔ∏è Oldest First
      </button>

      <button id="compactToggle"
        class="bg-purple-600 text-white hover:bg-purple-700 px-3 py-1 rounded mt-5 text-sm">
        üì¶ Compact: ON
      </button>
    </div>

    <div id="log-container" class="space-y-2"></div>

    <div id="pagination" class="mt-6 flex items-center justify-between border-t border-gray-300 dark:border-gray-700 pt-4">
      <div class="text-sm text-gray-600 dark:text-gray-400">
        Showing <span id="showing-start">0</span>-<span id="showing-end">0</span> of <span id="total-count">0</span> logs
      </div>
      <div class="flex items-center space-x-2">
        <label class="text-sm text-gray-600 dark:text-gray-400">Per page:</label>
        <select id="perPageSelect" class="border rounded px-2 py-1 text-sm dark:bg-gray-800 dark:border-gray-700">
          <option value="20">20</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
          <option value="200">200</option>
        </select>
      </div>
      <div class="flex space-x-2">
        <button id="prevPage" class="px-3 py-1 border rounded text-sm bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          Previous
        </button>
        <span class="px-3 py-1 text-sm text-gray-600 dark:text-gray-400">
          Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
        </span>
        <button id="nextPage" class="px-3 py-1 border rounded text-sm bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          Next
        </button>
      </div>
    </div>
  </div>

  <!-- JSON Modal -->
  <div id="jsonModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden flex flex-col">
      <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold">Log Entry JSON</h3>
        <button onclick="closeJsonModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl leading-none">
          &times;
        </button>
      </div>
      <div class="p-4 overflow-auto flex-1">
        <pre id="jsonModalContent" class="text-xs bg-gray-100 dark:bg-gray-900 p-3 rounded overflow-x-auto"></pre>
      </div>
    </div>
  </div>

  <script>
  const container = document.getElementById("log-container");
  const source = new EventSource("/stream");
  const levelFilter = document.getElementById("levelFilter");
  const sectionFilter = document.getElementById("sectionFilter");
  const groupFilter = document.getElementById("groupFilter");
  const runNameFilter = document.getElementById("runNameFilter");
  const runIdFilter = document.getElementById("runIdFilter");
  const timeFilter = document.getElementById("timeFilter");
  const clearBtn = document.getElementById("clearFilters");
  const sortToggle = document.getElementById("sortToggle");
  const compactToggle = document.getElementById("compactToggle");
  const printBtn = document.getElementById("printBtn");
  const liveRunBtn = document.getElementById("liveRunBtn");

  // Live run tracking
  let runsData = null;
  let latestRunIdForName = null;
  let latestRunNameExact = null;

  // Pagination elements
  const perPageSelect = document.getElementById("perPageSelect");
  const prevPageBtn = document.getElementById("prevPage");
  const nextPageBtn = document.getElementById("nextPage");
  const currentPageSpan = document.getElementById("currentPage");
  const totalPagesSpan = document.getElementById("totalPages");
  const showingStartSpan = document.getElementById("showing-start");
  const showingEndSpan = document.getElementById("showing-end");
  const totalCountSpan = document.getElementById("total-count");

  let allLogs = [];
  let knownLevels = new Set();
  let currentPage = 1;
  let perPage = 50;
  let sortOldestFirst = false;
  let compactMode = true;

  // Parse URL parameters
  function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
      level: params.get('level') || '',
      section: params.get('section') || '',
      group: params.get('group') || '',
      run_name: params.get('run_name') || '',
      run_id: params.get('run_id') || '',
      time: params.get('time') || ''
    };
  }

  // Apply URL parameters to filters
  function applyUrlParams() {
    const params = getUrlParams();
    if (params.level) levelFilter.value = params.level;
    if (params.section) sectionFilter.value = params.section;
    if (params.group) groupFilter.value = params.group;
    if (params.run_name) runNameFilter.value = params.run_name;
    if (params.run_id) runIdFilter.value = params.run_id;
    if (params.time) timeFilter.value = params.time;
  }

  // Apply filters from URL on page load
  applyUrlParams();

  function matchesFilters(entry) {
    const level = levelFilter.value.toLowerCase();
    const section = sectionFilter.value.toLowerCase();
    const group = groupFilter.value.toLowerCase();
    const runName = runNameFilter.value.toLowerCase();
    const runId = runIdFilter.value.toLowerCase();
    const timeRange = parseInt(timeFilter.value);

    if (level && (!entry.level || entry.level.toLowerCase() !== level)) return false;
    if (section && (!entry.section || !entry.section.toLowerCase().includes(section))) return false;
    if (group && (!entry.group || !entry.group.toLowerCase().includes(group))) return false;
    if (runName && (!entry.run_name || !entry.run_name.toLowerCase().includes(runName))) return false;
    if (runId && (!entry.run_id || !entry.run_id.toLowerCase().includes(runId))) return false;

    // Time range filter
    if (timeRange && entry.time) {
      const logTime = new Date(entry.time);
      const now = new Date();
      const diffSeconds = (now - logTime) / 1000;
      if (diffSeconds > timeRange) return false;
    }

    return true;
  }

  function updateLevelFilter() {
    const currentSelection = levelFilter.value;
    const sortedLevels = Array.from(knownLevels).sort();

    // Keep "All" option and rebuild the rest
    levelFilter.innerHTML = '<option value="">All</option>';
    sortedLevels.forEach(level => {
      const option = document.createElement('option');
      option.value = level.toLowerCase();
      option.textContent = level;
      levelFilter.appendChild(option);
    });

    // Restore previous selection if it still exists
    if (currentSelection) {
      levelFilter.value = currentSelection;
    }
  }

  function updatePaginationInfo(filteredLogs) {
    const totalLogs = filteredLogs.length;
    const totalPages = Math.max(1, Math.ceil(totalLogs / perPage));

    // Ensure current page is within bounds
    if (currentPage > totalPages) {
      currentPage = totalPages;
    }
    if (currentPage < 1) {
      currentPage = 1;
    }

    const startIdx = (currentPage - 1) * perPage;
    const endIdx = Math.min(startIdx + perPage, totalLogs);

    // Update pagination display
    currentPageSpan.textContent = currentPage;
    totalPagesSpan.textContent = totalPages;
    showingStartSpan.textContent = totalLogs > 0 ? startIdx + 1 : 0;
    showingEndSpan.textContent = endIdx;
    totalCountSpan.textContent = totalLogs;

    // Update button states
    prevPageBtn.disabled = currentPage <= 1;
    nextPageBtn.disabled = currentPage >= totalPages;
  }

  function renderLogs() {
    container.innerHTML = "";

    const filteredLogs = allLogs.filter(matchesFilters);
    // Sort based on toggle: newest first (default) or oldest first
    const sortedLogs = sortOldestFirst ? filteredLogs.slice() : filteredLogs.slice().reverse();

    // Calculate pagination
    const startIdx = (currentPage - 1) * perPage;
    const endIdx = startIdx + perPage;
    const pageLog = sortedLogs.slice(startIdx, endIdx);

    // Render logs for current page
    if (compactMode) {
      // In compact mode, group consecutive one-liners
      let i = 0;
      while (i < pageLog.length) {
        if (isOneLiner(pageLog[i])) {
          // Found a one-liner, collect consecutive one-liners
          const group = [pageLog[i]];
          i++;
          while (i < pageLog.length && isOneLiner(pageLog[i])) {
            group.push(pageLog[i]);
            i++;
          }
          // Render the group
          renderLogGroup(group);
        } else {
          // Not a one-liner, render normally
          renderLog(pageLog[i]);
          i++;
        }
      }
    } else {
      // Normal mode: render each log individually
      pageLog.forEach(renderLog);
    }

    // Update pagination info
    updatePaginationInfo(filteredLogs);

    // Load markdown files after rendering
    setTimeout(loadMarkdownFiles, 100);
  }

  function getTimeAgo(timestamp) {
    if (!timestamp) return '';

    // Parse timestamp - if it doesn't end with Z and looks like UTC, add Z
    let ts = timestamp;
    if (!ts.endsWith('Z') && !ts.includes('+') && !ts.includes('-', 10)) {
      // Looks like an ISO timestamp without timezone - treat as UTC
      ts = ts + 'Z';
    }

    const logTime = new Date(ts);
    const now = new Date();
    const diffMs = now - logTime;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHour = Math.floor(diffMin / 60);
    const diffDay = Math.floor(diffHour / 24);

    // Handle future timestamps
    if (diffSec < 0) {
      const absSec = Math.abs(diffSec);
      if (absSec < 60) return `in ${absSec}s`;
      const absMin = Math.floor(absSec / 60);
      if (absMin < 60) return `in ${absMin}m`;
      const absHour = Math.floor(absMin / 60);
      return `in ${absHour}h`;
    }

    if (diffSec < 10) return 'just now';
    if (diffSec < 60) return `${diffSec}s ago`;
    if (diffMin < 60) return `${diffMin}m ago`;
    if (diffHour < 24) return `${diffHour}h ago`;
    return `${diffDay}d ago`;
  }

  function renderRunInfo(entry) {
    if (!entry.run_name && !entry.run_id) return '';

    const parts = [];
    if (entry.run_name) parts.push(`run: <span class="font-semibold">${entry.run_name}</span>`);
    if (entry.run_id) parts.push(`id: <span class="font-semibold">${entry.run_id}</span>`);

    let url = '/runs';
    if (entry.run_id) {
      url = `/?run_id=${encodeURIComponent(entry.run_id)}`;
    } else if (entry.run_name) {
      url = `/?run_name=${encodeURIComponent(entry.run_name)}`;
    }

    return `<a href="${url}" class="text-xs text-blue-600 dark:text-blue-400 hover:underline ml-2">üîó ${parts.join(', ')}</a>`;
  }

  function getFileLanguage(ext) {
    const languageMap = {
      'js': 'javascript',
      'jsx': 'jsx',
      'ts': 'typescript',
      'tsx': 'tsx',
      'py': 'python',
      'rb': 'ruby',
      'java': 'java',
      'cpp': 'cpp',
      'c': 'c',
      'cs': 'csharp',
      'go': 'go',
      'rs': 'rust',
      'php': 'php',
      'sh': 'bash',
      'bash': 'bash',
      'zsh': 'bash',
      'sql': 'sql',
      'json': 'json',
      'yaml': 'yaml',
      'yml': 'yaml',
      'xml': 'xml',
      'html': 'html',
      'css': 'css',
      'scss': 'scss',
      'sass': 'sass',
      'less': 'less',
      'md': 'markdown',
      'txt': 'text',
      'log': 'text'
    };
    return languageMap[ext] || 'text';
  }

  // Check if an entry can be grouped in compact mode
  function isOneLiner(entry) {
    // In compact mode, all entries can be grouped together
    return true;
  }

  // Modal functions for JSON display
  window.openJsonModal = function(entryJson) {
    const modal = document.getElementById('jsonModal');
    const content = document.getElementById('jsonModalContent');
    content.textContent = JSON.stringify(entryJson, null, 2);
    modal.classList.remove('hidden');
  };

  window.closeJsonModal = function() {
    const modal = document.getElementById('jsonModal');
    modal.classList.add('hidden');
  };

  // Close modal on background click
  document.getElementById('jsonModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
      closeJsonModal();
    }
  });

  // Close modal on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeJsonModal();
    }
  });

  function renderCachePath(cachePath) {
    if (!cachePath) return '';

    const ext = cachePath.split('.').pop().toLowerCase();
    const cacheUrl = `/cache/${encodeURIComponent(cachePath)}`;
    const uniqueId = `file-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

    // Check if it's an image
    if (['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg', 'bmp'].includes(ext)) {
      return `<div class="mt-2">
        <div class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Cached Artifact:</div>
        <img src="${cacheUrl}" alt="Cached artifact" class="max-w-full h-auto rounded border border-gray-300 dark:border-gray-600 cursor-pointer"
             onclick="window.open('${cacheUrl}', '_blank')"
             style="max-height: 400px; object-fit: contain;" />
      </div>`;
    }

    // Check if it's a PDF
    if (ext === 'pdf') {
      return `<div class="mt-2">
        <div class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Cached Artifact (PDF):</div>
        <embed src="${cacheUrl}" type="application/pdf" class="w-full rounded border border-gray-300 dark:border-gray-600" style="height: 400px;" />
        <a href="${cacheUrl}" target="_blank" class="text-xs text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300">Open PDF in new tab</a>
      </div>`;
    }

    // Check if it's a markdown file
    if (ext === 'md') {
      return `<div class="mt-2">
        <div class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1 flex items-center justify-between">
          <span>Cached Artifact (Markdown):</span>
          <button onclick="toggleFileContent('${uniqueId}')" class="text-xs bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-2 py-1 rounded flex items-center gap-1">
            <span class="arrow transform transition-transform" id="arrow-${uniqueId}">‚ñº</span>
            <span class="btn-text" id="btn-${uniqueId}">Hide</span>
          </button>
        </div>
        <div id="content-${uniqueId}" class="markdown-content bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded p-3 max-h-96 overflow-y-auto">
          Loading markdown...
        </div>
        <a href="${cacheUrl}" target="_blank" class="text-xs text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 mt-1 inline-block">Open file in new tab</a>
      </div>`;
    }

    // Check if it's a code file
    const language = getFileLanguage(ext);
    if (['javascript', 'jsx', 'typescript', 'tsx', 'python', 'ruby', 'java', 'cpp', 'c', 'csharp', 'go', 'rust', 'php', 'bash', 'sql', 'json', 'yaml', 'xml', 'html', 'css', 'scss', 'sass', 'less'].includes(language)) {
      return `<div class="mt-2">
        <div class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1 flex items-center justify-between">
          <span>Cached Artifact (${language.toUpperCase()}):</span>
          <button onclick="toggleFileContent('${uniqueId}')" class="text-xs bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-2 py-1 rounded flex items-center gap-1">
            <span class="arrow transform transition-transform" id="arrow-${uniqueId}">‚ñ∂</span>
            <span class="btn-text" id="btn-${uniqueId}">Show</span>
          </button>
        </div>
        <div id="content-${uniqueId}" class="hidden code-content bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded max-h-96 overflow-y-auto">
          <pre class="text-sm"><code class="language-${language}">Loading code...</code></pre>
        </div>
        <a href="${cacheUrl}" target="_blank" class="text-xs text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 mt-1 inline-block">Open file in new tab</a>
      </div>`;
    }

    // For other file types, just show a link
    return `<div class="mt-2">
      <div class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Cached Artifact:</div>
      <a href="${cacheUrl}" target="_blank" class="text-sm text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 underline">
        üìé ${cachePath}
      </a>
    </div>`;
  }

  function renderLog(entry) {
    const div = document.createElement("div");
    const levelLower = (entry.level || '').toLowerCase();
    const border =
      levelLower === "error" ? "border-red-500" :
      levelLower === "warn" || levelLower === "warning" ? "border-yellow-400" :
      levelLower === "debug" ? "border-gray-400" :
      "border-blue-400";
    div.className = `p-3 bg-white dark:bg-gray-800 border-l-4 ${border} rounded shadow-sm transition`;

    const timeAgo = getTimeAgo(entry.time);
    const timeDisplay = entry.time ? `<span class="time-ago font-medium text-gray-700 dark:text-gray-200" data-timestamp="${entry.time}">${timeAgo}</span>` : '';

    const cachePathHtml = renderCachePath(entry.cache_path);
    const runInfoHtml = renderRunInfo(entry);

    // Use 'message' field for HTML content, fallback to 'msg' or 'event'
    const mainContent = entry.message || entry.msg || entry.event || '';

    // Generate unique ID for collapse functionality
    const uniqueId = `json-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

    div.innerHTML = `
      <div class="flex justify-between text-sm text-gray-600 dark:text-gray-300">
        <div class="flex items-center space-x-2">
          ${timeDisplay}
          <span class="text-xs">${entry.time || ''}</span>
          ${renderFileLocation(entry)}
        </div>
        <div class="flex items-center space-x-2">
          <span class="font-semibold">${entry.level || ''}</span>
          <span>${entry.section || ''}</span>
          ${runInfoHtml}
        </div>
      </div>
      <div class="mt-2 text-gray-900 dark:text-gray-100 font-mono text-sm whitespace-pre-wrap leading-normal">${mainContent}</div>
      ${cachePathHtml}
      <div class="mt-2">
        <button onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('.arrow').style.transform = this.nextElementSibling.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(90deg)'; this.querySelector('.btn-text').textContent = this.nextElementSibling.classList.contains('hidden') ? 'Show JSON' : 'Hide JSON';"
                class="text-xs text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 flex items-center gap-1">
          <span class="arrow transform transition-transform" style="transform: rotate(0deg)">‚ñ∂</span>
          <span class="btn-text">Show JSON</span>
        </button>
        <pre class="hidden mt-1 text-xs bg-gray-100 dark:bg-gray-900 p-2 rounded overflow-x-auto">${JSON.stringify(entry, null, 2)}</pre>
      </div>
    `;

    container.appendChild(div);
  }

  // Render a compact version of cache path artifacts
  function renderCompactCachePath(cachePath) {
    if (!cachePath) return '';

    const ext = cachePath.split('.').pop().toLowerCase();
    const cacheUrl = `/cache/${encodeURIComponent(cachePath)}`;
    const uniqueId = `file-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

    // Check if it's an image
    if (['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg', 'bmp'].includes(ext)) {
      return `<div class="mt-1 w-full flex justify-center">
        <img src="${cacheUrl}" alt="Artifact" class="max-w-full h-auto rounded border border-gray-300 dark:border-gray-600 cursor-pointer"
             onclick="window.open('${cacheUrl}', '_blank')"
             style="max-height: 300px; object-fit: contain;" />
      </div>`;
    }

    // For non-image files, return empty (icon will be rendered separately)
    return '';
  }

  // Helper function to render attachment icon for non-image cached files
  function renderCompactFileIcon(cachePath) {
    if (!cachePath) return '';

    const ext = cachePath.split('.').pop().toLowerCase();
    // Don't render icon for images (they display inline)
    if (['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg', 'bmp'].includes(ext)) {
      return '';
    }

    const cacheUrl = `/cache/${encodeURIComponent(cachePath)}`;
    const fileName = cachePath.split('/').pop();

    return `<a href="${cacheUrl}" target="_blank"
               class="relative group text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 ml-0.5"
               title="${fileName}">
              <svg class="w-3 h-3 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
              </svg>
              <span class="invisible group-hover:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 text-[10px] bg-gray-900 dark:bg-gray-700 text-white rounded whitespace-nowrap z-10">${fileName}</span>
            </a>`;
  }

  // Helper function to render file location link
  function renderFileLocation(entry) {
    if (!entry.file || !entry.line) return '';

    const fileName = entry.file.split('/').pop();

    // Strip workspace prefix for dev container compatibility
    const workspacePrefix = '/home/jovyan/workspace';
    let relativePath = entry.file;
    if (entry.file.startsWith(workspacePrefix)) {
      relativePath = entry.file.substring(workspacePrefix.length);
    }

    const vscodeUrl = `vscode://file${relativePath}:${entry.line}`;

    return `<a href="${vscodeUrl}"
               class="relative group text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 ml-1"
               title="${entry.file}:${entry.line}">
              <svg class="w-3 h-3 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              <span class="invisible group-hover:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 text-[10px] bg-gray-900 dark:bg-gray-700 text-white rounded whitespace-nowrap z-10">${fileName}:${entry.line}</span>
            </a>`;
  }

  // Render a group of log entries in compact mode
  function renderLogGroup(entries) {
    const div = document.createElement("div");
    div.className = `p-3 bg-white dark:bg-gray-800 border-l-4 border-gray-400 rounded shadow-sm transition`;

    const groupHtml = entries.map(entry => {
      const timeAgo = getTimeAgo(entry.time);
      const timeDisplay = entry.time ? `<span class="time-ago text-gray-500 dark:text-gray-400 min-w-[3.5rem] inline-block" data-timestamp="${entry.time}">${timeAgo}</span>` : '';
      const mainContent = entry.message || entry.msg || entry.event || '';
      const levelLower = (entry.level || '').toLowerCase();
      const levelColor =
        levelLower === "error" ? "text-red-600 dark:text-red-400" :
        levelLower === "warn" || levelLower === "warning" ? "text-yellow-600 dark:text-yellow-400" :
        levelLower === "debug" ? "text-gray-500 dark:text-gray-400" :
        "text-blue-600 dark:text-blue-400";

      const artifactHtml = renderCompactCachePath(entry.cache_path);
      const fileIconHtml = renderCompactFileIcon(entry.cache_path);
      const fileLocationHtml = renderFileLocation(entry);

      return `
        <div class="flex items-baseline gap-1 text-xs leading-none -my-px">
          ${timeDisplay}
          <span class="font-semibold ${levelColor}">${entry.level || ''}</span>
          ${entry.section ? `<span class="text-gray-500 dark:text-gray-400">${entry.section}</span>` : ''}
          <span class="flex-1 text-gray-900 dark:text-gray-100 font-mono whitespace-pre-wrap leading-normal">${mainContent}</span>
          <span class="inline-flex items-center">${fileIconHtml}${fileLocationHtml}<button onclick='openJsonModal(${JSON.stringify(entry).replace(/'/g, "&#39;")})' class="text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 ml-0.5" title="View JSON"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg></button></span>
        </div>
        ${artifactHtml}
      `;
    }).join('');

    div.innerHTML = `
      <div class="text-xs text-gray-500 dark:text-gray-400 mb-2 font-semibold">
        ${entries.length} grouped ${entries.length === 1 ? 'entry' : 'entries'}
      </div>
      ${groupHtml}
    `;

    container.appendChild(div);
  }

  function prependLog(entry) {
    const div = document.createElement("div");
    const levelLower = (entry.level || '').toLowerCase();
    const border =
      levelLower === "error" ? "border-red-500" :
      levelLower === "warn" || levelLower === "warning" ? "border-yellow-400" :
      levelLower === "debug" ? "border-gray-400" :
      "border-blue-400";
    div.className = `p-3 bg-white dark:bg-gray-800 border-l-4 ${border} rounded shadow-sm transition`;

    const timeAgo = getTimeAgo(entry.time);
    const timeDisplay = entry.time ? `<span class="time-ago font-medium text-gray-700 dark:text-gray-200" data-timestamp="${entry.time}">${timeAgo}</span>` : '';

    const cachePathHtml = renderCachePath(entry.cache_path);
    const runInfoHtml = renderRunInfo(entry);
    const mainContent = entry.message || entry.msg || entry.event || '';

    div.innerHTML = `
      <div class="flex justify-between text-sm text-gray-600 dark:text-gray-300">
        <div class="flex items-center space-x-2">
          ${timeDisplay}
          <span class="text-xs">${entry.time || ''}</span>
          ${renderFileLocation(entry)}
        </div>
        <div class="flex items-center space-x-2">
          <span class="font-semibold">${entry.level || ''}</span>
          <span>${entry.section || ''}</span>
          ${runInfoHtml}
        </div>
      </div>
      <div class="mt-2 text-gray-900 dark:text-gray-100 font-mono text-sm whitespace-pre-wrap leading-normal">${mainContent}</div>
      ${cachePathHtml}
      <div class="mt-2">
        <button onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('.arrow').style.transform = this.nextElementSibling.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(90deg)'; this.querySelector('.btn-text').textContent = this.nextElementSibling.classList.contains('hidden') ? 'Show JSON' : 'Hide JSON';"
                class="text-xs text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 flex items-center gap-1">
          <span class="arrow transform transition-transform" style="transform: rotate(0deg)">‚ñ∂</span>
          <span class="btn-text">Show JSON</span>
        </button>
        <pre class="hidden mt-1 text-xs bg-gray-100 dark:bg-gray-900 p-2 rounded overflow-x-auto">${JSON.stringify(entry, null, 2)}</pre>
      </div>
    `;

    container.insertBefore(div, container.firstChild);
  }

  source.onmessage = (event) => {
    const entry = JSON.parse(event.data);
    allLogs.push(entry);

    // Track new log levels and update filter dropdown
    if (entry.level && !knownLevels.has(entry.level)) {
      knownLevels.add(entry.level);
      updateLevelFilter();
    }

    // With pagination, we need to re-render when new entries arrive
    // if we're on page 1 (to show newest entries) or if filters are active
    if (matchesFilters(entry)) {
      const hasActiveFilters = levelFilter.value || sectionFilter.value || groupFilter.value || runNameFilter.value || runIdFilter.value || timeFilter.value;

      if (currentPage === 1 && !hasActiveFilters) {
        // On page 1 with no filters, we can optimize by prepending
        const filteredCount = allLogs.filter(matchesFilters).length;
        if (filteredCount <= perPage) {
          prependLog(entry);
          updatePaginationInfo(allLogs.filter(matchesFilters));
        } else {
          renderLogs();
        }
      } else {
        // Otherwise re-render to maintain pagination integrity
        renderLogs();
      }
    }
  };

  // Function to update all time-ago displays
  function updateTimeDisplays() {
    document.querySelectorAll('.time-ago').forEach(element => {
      const timestamp = element.getAttribute('data-timestamp');
      if (timestamp) {
        element.textContent = getTimeAgo(timestamp);
      }
    });
  }

  // Update time displays every 5 seconds for better responsiveness
  setInterval(updateTimeDisplays, 5000);

  // File content toggle and loading functions
  window.toggleFileContent = function(uniqueId) {
    const content = document.getElementById(`content-${uniqueId}`);
    const arrow = document.getElementById(`arrow-${uniqueId}`);
    const btn = document.getElementById(`btn-${uniqueId}`);

    if (content.classList.contains('hidden')) {
      // Show content
      content.classList.remove('hidden');
      arrow.style.transform = 'rotate(90deg)';

      // Update button text based on content type
      const isMarkdown = content.classList.contains('markdown-content');
      const isCode = content.classList.contains('code-content');
      if (isMarkdown || isCode) {
        btn.textContent = 'Hide';
      } else {
        btn.textContent = 'Hide';
      }

      // Load content if not already loaded
      // Check if content contains "Loading" text or if code element contains "Loading"
      const needsLoading = content.textContent.includes('Loading') ||
                          content.querySelector('code')?.textContent.includes('Loading');

      if (needsLoading) {
        loadFileContent(uniqueId);
      }
    } else {
      // Hide content
      content.classList.add('hidden');
      arrow.style.transform = 'rotate(0deg)';

      // Update button text based on content type
      const isMarkdown = content.classList.contains('markdown-content');
      const isCode = content.classList.contains('code-content');
      if (isMarkdown) {
        btn.textContent = 'Show Markdown';
      } else if (isCode) {
        // Try to extract language from button text or code class
        const codeElement = content.querySelector('code');
        if (codeElement) {
          const langClass = Array.from(codeElement.classList).find(c => c.startsWith('language-'));
          const lang = langClass ? langClass.replace('language-', '').toUpperCase() : 'Code';
          btn.textContent = `Show ${lang}`;
        } else {
          btn.textContent = 'Show';
        }
      } else {
        btn.textContent = 'Show';
      }
    }
  };

  async function loadFileContent(uniqueId) {
    const content = document.getElementById(`content-${uniqueId}`);

    // Find the cache URL - try multiple strategies
    let cacheLink = null;

    // Strategy 1: Look in parent element (compact view)
    if (content.parentElement) {
      cacheLink = content.parentElement.querySelector('a[href*="/cache/"]');
    }

    // Strategy 2: Look in closest .mt-2 or .mt-1 container
    if (!cacheLink) {
      const container = content.closest('.mt-2') || content.closest('.mt-1');
      if (container) {
        cacheLink = container.querySelector('a[href*="/cache/"]');
      }
    }

    // Strategy 3: Look in the previous sibling (for compact view where button is before content)
    if (!cacheLink && content.previousElementSibling) {
      cacheLink = content.previousElementSibling.querySelector('a[href*="/cache/"]');
    }

    if (!cacheLink) {
      content.innerHTML = `<div class="text-red-500 text-sm">Error: Could not find cache URL</div>`;
      return;
    }

    const cacheUrl = cacheLink.href;

    try {
      const response = await fetch(cacheUrl);
      const text = await response.text();

      if (content.classList.contains('markdown-content')) {
        // Render markdown
        content.innerHTML = marked.parse(text);
      } else if (content.classList.contains('code-content')) {
        // Render code with syntax highlighting
        const codeElement = content.querySelector('code');
        codeElement.textContent = text;
        Prism.highlightElement(codeElement);
      }
    } catch (error) {
      content.innerHTML = `<div class="text-red-500 text-sm">Error loading file: ${error.message}</div>`;
    }
  }

  // Load markdown files immediately (since they're shown by default)
  function loadMarkdownFiles() {
    document.querySelectorAll('.markdown-content').forEach((element) => {
      if (element.textContent.includes('Loading')) {
        const uniqueId = element.id.replace('content-', '');
        loadFileContent(uniqueId);
      }
    });
  }

  // Initial render when page loads
  renderLogs();

  // Re-render logs every minute if time filter is active (to hide old entries)
  setInterval(() => {
    if (timeFilter.value) {
      renderLogs();
    }
  }, 60000);

  levelFilter.onchange = () => {
    currentPage = 1; // Reset to page 1 when filters change
    renderLogs();
  };
  sectionFilter.oninput = () => {
    currentPage = 1;
    renderLogs();
  };
  groupFilter.oninput = () => {
    currentPage = 1;
    renderLogs();
  };
  runNameFilter.oninput = () => {
    currentPage = 1;
    renderLogs();
  };
  runIdFilter.oninput = () => {
    currentPage = 1;
    renderLogs();
  };
  timeFilter.onchange = () => {
    currentPage = 1;
    renderLogs();
  };
  clearBtn.onclick = () => {
    levelFilter.value = "";
    sectionFilter.value = "";
    groupFilter.value = "";
    runNameFilter.value = "";
    runIdFilter.value = "";
    timeFilter.value = "";
    currentPage = 1;
    renderLogs();
  };

  // Pagination controls
  prevPageBtn.onclick = () => {
    if (currentPage > 1) {
      currentPage--;
      renderLogs();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  };

  nextPageBtn.onclick = () => {
    const totalPages = Math.ceil(allLogs.filter(matchesFilters).length / perPage);
    if (currentPage < totalPages) {
      currentPage++;
      renderLogs();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  };

  perPageSelect.onchange = () => {
    perPage = parseInt(perPageSelect.value);
    currentPage = 1; // Reset to page 1 when changing per page
    renderLogs();
  };

  // Sort toggle
  sortToggle.onclick = () => {
    sortOldestFirst = !sortOldestFirst;
    sortToggle.textContent = sortOldestFirst ? '‚¨áÔ∏è Newest First' : '‚¨ÜÔ∏è Oldest First';
    currentPage = 1; // Reset to page 1 when changing sort
    renderLogs();
  };

  // Compact mode toggle
  compactToggle.onclick = () => {
    compactMode = !compactMode;

    if (compactMode) {
      // ON state
      compactToggle.className = 'bg-purple-600 text-white hover:bg-purple-700 px-3 py-1 rounded mt-5 text-sm';
      compactToggle.textContent = 'üì¶ Compact: ON';
    } else {
      // OFF state
      compactToggle.className = 'bg-purple-100 dark:bg-purple-900 hover:bg-purple-200 dark:hover:bg-purple-800 px-3 py-1 rounded mt-5 text-sm';
      compactToggle.textContent = 'üì¶ Compact View';
    }

    renderLogs();
  };

  // Print functionality - opens a clean print page
  printBtn.onclick = () => {
    const filteredLogs = allLogs.filter(matchesFilters);

    if (filteredLogs.length === 0) {
      alert('No logs to print with current filters.');
      return;
    }

    // Sort by time (oldest first for chronological reading)
    const sortedByTime = filteredLogs.slice().sort((a, b) => {
      const timeA = a.time ? new Date(a.time) : new Date(0);
      const timeB = b.time ? new Date(b.time) : new Date(0);
      return timeA - timeB;
    });

    const firstEntry = sortedByTime[0];
    const lastEntry = sortedByTime[sortedByTime.length - 1];

    // Check for unique run name across all filtered logs
    const runNames = new Set(filteredLogs.map(e => e.run_name).filter(Boolean));
    const uniqueRunName = runNames.size === 1 ? Array.from(runNames)[0] : null;

    // Determine report title and filename
    const reportTitle = uniqueRunName ? `Log4Lab Report ‚Äî ${uniqueRunName}` : 'Log4Lab Report';
    const docTitle = uniqueRunName || 'Log4Lab Report';

    // Format date
    const formatDateTime = (timestamp) => {
      if (!timestamp) return '-';
      const date = new Date(timestamp);
      return date.toLocaleString();
    };

    // Calculate duration
    const calculateDuration = (start, end) => {
      if (!start || !end) return '-';
      const diffMs = new Date(end) - new Date(start);
      if (diffMs < 0) return '-';
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHour = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHour / 24);
      if (diffDay > 0) return `${diffDay}d ${diffHour % 24}h ${diffMin % 60}m`;
      if (diffHour > 0) return `${diffHour}h ${diffMin % 60}m ${diffSec % 60}s`;
      if (diffMin > 0) return `${diffMin}m ${diffSec % 60}s`;
      return `${diffSec}s`;
    };

    // Build active filters list
    const activeFilters = [];
    if (levelFilter.value) activeFilters.push(`Level: ${levelFilter.value}`);
    if (sectionFilter.value) activeFilters.push(`Section: ${sectionFilter.value}`);
    if (groupFilter.value) activeFilters.push(`Group: ${groupFilter.value}`);
    if (runNameFilter.value) activeFilters.push(`Run Name: ${runNameFilter.value}`);
    if (runIdFilter.value) activeFilters.push(`Run ID: ${runIdFilter.value}`);
    if (timeFilter.value) {
      const timeLabels = { '60': '1 min', '300': '5 min', '600': '10 min', '1800': '30 min', '3600': '1 hour', '21600': '6 hours', '86400': '24 hours' };
      activeFilters.push(`Time: Last ${timeLabels[timeFilter.value] || timeFilter.value + 's'}`);
    }

    // Generate log content HTML
    const logsHtml = sortedByTime.map(entry => {
      const content = entry.message || entry.msg || entry.event || '';
      const section = entry.section ? `<span style="color: #666; font-size: 12px;">[${entry.section}]</span> ` : '';

      // Handle cached images
      let imageHtml = '';
      if (entry.cache_path) {
        const ext = entry.cache_path.split('.').pop().toLowerCase();
        if (['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg', 'bmp'].includes(ext)) {
          const cacheUrl = `/cache/${encodeURIComponent(entry.cache_path)}`;
          imageHtml = `<div style="margin-top: 8px; text-align: center;"><img src="${cacheUrl}" style="max-width: 100%; max-height: 400px; object-fit: contain;"></div>`;
        }
      }

      return `<div style="margin-bottom: 6px; page-break-inside: avoid;">
        ${section}<span style="font-family: monospace; white-space: pre-wrap;">${content}</span>
        ${imageHtml}
      </div>`;
    }).join('');

    // Create print page HTML
    const printHtml = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>${docTitle}</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; color: #333; }
    .header { border-bottom: 2px solid #333; padding-bottom: 16px; margin-bottom: 24px; }
    .header h1 { margin: 0 0 12px 0; font-size: 24px; }
    .header-info { display: grid; grid-template-columns: auto 1fr; gap: 4px 16px; font-size: 14px; color: #555; }
    .header-info dt { font-weight: 600; }
    .header-info dd { margin: 0; }
    .content { line-height: 1.3; }
    img { page-break-inside: avoid; }
    @media print {
      body { padding: 0; }
      img { max-height: 500px !important; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>${reportTitle}</h1>
    <dl class="header-info">
      <dt>First Entry:</dt><dd>${formatDateTime(firstEntry?.time)}</dd>
      <dt>Last Entry:</dt><dd>${formatDateTime(lastEntry?.time)}</dd>
      <dt>Duration:</dt><dd>${calculateDuration(firstEntry?.time, lastEntry?.time)}</dd>
      <dt>Entries:</dt><dd>${sortedByTime.length}</dd>
      ${activeFilters.length > 0 ? `<dt>Filters:</dt><dd>${activeFilters.join(' | ')}</dd>` : ''}
    </dl>
  </div>
  <div class="content">
    ${logsHtml}
  </div>
</body>
</html>`;

    // Open new window and print
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printHtml);
    printWindow.document.close();
    printWindow.onload = () => {
      printWindow.print();
    };
  };

  // Live Run button functionality
  // Fetches runs data and shows a "Live" button when viewing a run name
  // that has a newer run ID with more recent activity
  async function fetchRunsData() {
    try {
      const response = await fetch('/api/runs');
      runsData = await response.json();
      checkForNewerRun();
    } catch (error) {
      console.error('Error fetching runs data:', error);
    }
  }

  function checkForNewerRun() {
    const currentRunName = runNameFilter.value.trim();
    const currentRunNameLower = currentRunName.toLowerCase();
    const currentRunId = runIdFilter.value.trim().toLowerCase();

    // Hide button by default
    liveRunBtn.classList.add('hidden');
    latestRunIdForName = null;
    latestRunNameExact = null;

    if (!currentRunName || !runsData || !runsData.runs) {
      return;
    }

    // First try to find an exact match for the run name
    let matchedRunName = null;
    for (const runName of Object.keys(runsData.runs)) {
      if (runName.toLowerCase() === currentRunNameLower) {
        matchedRunName = runName;
        break;
      }
    }

    // If no exact match, try fuzzy match
    if (!matchedRunName) {
      for (const runName of Object.keys(runsData.runs)) {
        if (runName.toLowerCase().includes(currentRunNameLower) || currentRunNameLower.includes(runName.toLowerCase())) {
          matchedRunName = runName;
          break;
        }
      }
    }

    if (!matchedRunName) {
      return;
    }

    const runIds = runsData.runs[matchedRunName].run_ids;
    if (!runIds || runIds.length === 0) {
      return;
    }

    // Find the run ID with the most recent "latest" timestamp
    let mostRecentRunId = null;
    let mostRecentTime = null;

    for (const runIdInfo of runIds) {
      if (runIdInfo.latest) {
        // Parse timestamp
        let ts = runIdInfo.latest;
        if (!ts.endsWith('Z') && !ts.includes('+') && !ts.includes('-', 10)) {
          ts = ts + 'Z';
        }
        const runTime = new Date(ts);

        if (!mostRecentTime || runTime.getTime() > mostRecentTime.getTime()) {
          mostRecentTime = runTime;
          mostRecentRunId = runIdInfo.run_id;
        }
      }
    }

    if (!mostRecentRunId) {
      return;
    }

    // Check if we're currently viewing a different (older) run ID
    const isViewingDifferentRun = currentRunId && currentRunId !== mostRecentRunId.toLowerCase();

    // Also check if the logs we're seeing are from a different run ID
    const logsForCurrentName = allLogs.filter(log =>
      log.run_name && log.run_name.toLowerCase() === matchedRunName.toLowerCase()
    );

    if (logsForCurrentName.length > 0) {
      // Get the run IDs from current logs
      const runIdsInView = new Set(logsForCurrentName.map(log => log.run_id).filter(Boolean));

      // If the most recent run ID is not in our current view, show the button
      if (!runIdsInView.has(mostRecentRunId)) {
        latestRunIdForName = mostRecentRunId;
        latestRunNameExact = matchedRunName;
        liveRunBtn.classList.remove('hidden');
        liveRunBtn.title = `Jump to latest run: ${matchedRunName} (${mostRecentRunId})`;
        return;
      }
    }

    // If viewing a specific different run ID, show the button
    if (isViewingDifferentRun) {
      latestRunIdForName = mostRecentRunId;
      latestRunNameExact = matchedRunName;
      liveRunBtn.classList.remove('hidden');
      liveRunBtn.title = `Jump to latest run: ${matchedRunName} (${mostRecentRunId})`;
    }
  }

  // Live button click handler
  liveRunBtn.onclick = () => {
    if (latestRunIdForName) {
      // Set exact run name and run ID filters
      if (latestRunNameExact) {
        runNameFilter.value = latestRunNameExact;
      }
      runIdFilter.value = latestRunIdForName;
      currentPage = 1;
      renderLogs();
      liveRunBtn.classList.add('hidden');

      // Update URL to reflect the new run name and ID
      const url = new URL(window.location);
      if (latestRunNameExact) {
        url.searchParams.set('run_name', latestRunNameExact);
      }
      url.searchParams.set('run_id', latestRunIdForName);
      window.history.replaceState({}, '', url);
    }
  };

  // Fetch runs data on page load
  fetchRunsData();

  // Refresh runs data periodically (every 30 seconds)
  setInterval(fetchRunsData, 30000);

  // Also check for newer runs when logs are received
  source.addEventListener('message', () => {
    // Debounce the fetch to avoid too many API calls
    clearTimeout(window._fetchRunsTimeout);
    window._fetchRunsTimeout = setTimeout(fetchRunsData, 3000);
  });

  // Check when run name filter changes
  runNameFilter.addEventListener('input', () => {
    setTimeout(checkForNewerRun, 500);
  });

  // Check when run ID filter changes
  runIdFilter.addEventListener('input', () => {
    setTimeout(checkForNewerRun, 500);
  });
  </script>
</body>
</html>
