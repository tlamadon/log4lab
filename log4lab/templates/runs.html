<!DOCTYPE html>
<html lang="en" class="dark:bg-gray-900 dark:text-gray-100">
<head>
  <meta charset="UTF-8">
  <title>Log4Lab â€” Run IDs</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke-linecap='round' stroke-linejoin='round'><path d='M4 3v18h14' stroke='%234F46E5' stroke-width='3'/><circle cx='14' cy='10' r='5' stroke='%236366F1' stroke-width='2' fill='white'/><line x1='18' y1='14' x2='21' y2='17' stroke='%236366F1' stroke-width='2'/></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    if (localStorage.theme === 'dark' ||
        (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors">
  <div class="max-w-6xl mx-auto p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">Log4Lab <span class="text-sm font-light">(Runs Index)</span></h1>
      <div class="flex space-x-2">
        <a href="/" class="px-3 py-1 rounded border text-sm bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700">
          ðŸ“Š View Logs
        </a>
        <a href="https://github.com/tlamadon/log4lab" target="_blank" class="px-3 py-1 rounded border text-sm bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700">
          <svg class="inline-block w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
          </svg>
          GitHub
        </a>
        <button id="themeToggle"
          class="px-3 py-1 rounded border text-sm bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 dark:hover:bg-gray-700">
          Toggle Theme
        </button>
      </div>
    </div>

    <div class="mb-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded border border-blue-200 dark:border-blue-800">
      <p class="text-sm text-blue-800 dark:text-blue-200">
        Click on any row to view that run's logs. Runs are color-coded by recency (stronger colors = more recent).
      </p>
    </div>

    <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
      <p class="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-2">RECENCY (stronger color = more recent):</p>
      <div class="flex flex-wrap gap-3 text-xs">
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-blue-200 dark:bg-blue-600/50 border border-blue-400 dark:border-blue-500 rounded"></div>
          <span class="text-gray-700 dark:text-gray-300">Today</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-blue-100 dark:bg-blue-600/35 border border-blue-300 dark:border-blue-600 rounded"></div>
          <span class="text-gray-700 dark:text-gray-300">This Week</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-blue-50 dark:bg-blue-600/20 border border-blue-200 dark:border-blue-700 rounded"></div>
          <span class="text-gray-700 dark:text-gray-300">This Month</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-gray-50 dark:bg-blue-600/10 border border-blue-100 dark:border-blue-800 rounded"></div>
          <span class="text-gray-700 dark:text-gray-300">Older</span>
        </div>
      </div>
    </div>

    <div id="loading" class="text-center py-8">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 dark:border-gray-100"></div>
      <p class="mt-2 text-gray-600 dark:text-gray-400">Loading runs...</p>
    </div>

    <div id="run-container" class="hidden">
      <div class="mb-4 text-sm text-gray-600 dark:text-gray-400">
        Found <span id="run-count" class="font-semibold">0</span> unique run names with <span id="total-runs" class="font-semibold">0</span> total runs
      </div>

      <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-300 dark:border-gray-700 overflow-hidden">
        <table id="run-table" class="w-full">
          <thead class="bg-gray-100 dark:bg-gray-700 border-b border-gray-300 dark:border-gray-600">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Run Name</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Date</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Last Activity</th>
              <th class="px-3 py-2 text-right text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Entries</th>
              <th class="px-3 py-2 text-right text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Duration</th>
            </tr>
          </thead>
          <tbody id="run-list" class="divide-y divide-gray-200 dark:divide-gray-700">
          </tbody>
        </table>
      </div>
    </div>

    <div id="no-runs" class="hidden text-center py-8 text-gray-600 dark:text-gray-400">
      <p>No runs found in the log file.</p>
      <p class="text-sm mt-2">Runs are identified by the "run_name" and "run_id" fields in log entries.</p>
    </div>
  </div>

  <script>
  const themeToggle = document.getElementById("themeToggle");
  const loading = document.getElementById("loading");
  const runContainer = document.getElementById("run-container");
  const noRuns = document.getElementById("no-runs");
  const runList = document.getElementById("run-list");
  const runCount = document.getElementById("run-count");
  const totalRuns = document.getElementById("total-runs");

  themeToggle.onclick = () => {
    const html = document.documentElement;
    if (html.classList.contains('dark')) {
      html.classList.remove('dark');
      localStorage.theme = 'light';
    } else {
      html.classList.add('dark');
      localStorage.theme = 'dark';
    }
  };

  // Helper function to get time period category
  function getTimePeriod(timestamp) {
    if (!timestamp) return 'older';

    // Handle timestamp with or without 'Z'
    let ts = timestamp;
    if (!ts.endsWith('Z') && !ts.includes('+') && !ts.includes('-', 10)) {
      ts = ts + 'Z';
    }

    const runDate = new Date(ts);
    const now = new Date();

    // Reset time to start of day for accurate comparisons
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const runDay = new Date(runDate.getFullYear(), runDate.getMonth(), runDate.getDate());

    // Check if today
    if (runDay.getTime() === today.getTime()) {
      return 'today';
    }

    // Check if this week (last 7 days)
    const weekAgo = new Date(today);
    weekAgo.setDate(weekAgo.getDate() - 7);
    if (runDay >= weekAgo) {
      return 'week';
    }

    // Check if this month (last 30 days)
    const monthAgo = new Date(today);
    monthAgo.setDate(monthAgo.getDate() - 30);
    if (runDay >= monthAgo) {
      return 'month';
    }

    return 'older';
  }

  // Helper function to get color classes based on time period
  // Uses blue with varying opacity - stronger for more recent runs
  function getColorClasses(period) {
    const colors = {
      'today': 'bg-blue-200 dark:bg-blue-600/50 border-blue-400 dark:border-blue-500 hover:bg-blue-300 dark:hover:bg-blue-500/60',
      'week': 'bg-blue-100 dark:bg-blue-600/35 border-blue-300 dark:border-blue-600 hover:bg-blue-200 dark:hover:bg-blue-500/45',
      'month': 'bg-blue-50 dark:bg-blue-600/20 border-blue-200 dark:border-blue-700 hover:bg-blue-100 dark:hover:bg-blue-500/30',
      'older': 'bg-gray-50 dark:bg-blue-600/10 border-blue-100 dark:border-blue-800 hover:bg-blue-50 dark:hover:bg-blue-500/15'
    };
    return colors[period] || colors['older'];
  }

  // Helper function to format "time ago" string
  function formatTimeAgo(timestamp) {
    if (!timestamp) return { text: 'N/A', isRecent: false };

    let ts = timestamp;
    if (!ts.endsWith('Z') && !ts.includes('+') && !ts.includes('-', 10)) {
      ts = ts + 'Z';
    }

    const date = new Date(ts);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    const isRecent = diffMins <= 15;

    let text;
    if (diffMins < 1) {
      text = 'just now';
    } else if (diffMins < 60) {
      text = `${diffMins}m ago`;
    } else if (diffHours < 24) {
      text = `${diffHours}h ago`;
    } else if (diffDays < 30) {
      text = `${diffDays}d ago`;
    } else {
      text = `${Math.floor(diffDays / 30)}mo ago`;
    }

    return { text, isRecent };
  }

  // Helper function to format date and calculate duration
  function formatRunInfo(earliest, latest) {
    if (!earliest) {
      return { date: 'N/A', duration: 'N/A', period: 'older' };
    }

    // Handle timestamp with or without 'Z'
    let ts = earliest;
    if (!ts.endsWith('Z') && !ts.includes('+') && !ts.includes('-', 10)) {
      ts = ts + 'Z';
    }

    const startDate = new Date(ts);
    const dateStr = startDate.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

    const period = getTimePeriod(earliest);

    if (!latest || earliest === latest) {
      return { date: dateStr, duration: '0h', period };
    }

    // Calculate duration in hours
    let tsLatest = latest;
    if (!tsLatest.endsWith('Z') && !tsLatest.includes('+') && !tsLatest.includes('-', 10)) {
      tsLatest = tsLatest + 'Z';
    }
    const endDate = new Date(tsLatest);
    const durationMs = endDate - startDate;
    const durationHours = Math.round(durationMs / (1000 * 60 * 60) * 10) / 10; // Round to 1 decimal

    return {
      date: dateStr,
      duration: durationHours >= 1 ? `${durationHours}h` : `${Math.round(durationMs / (1000 * 60))}m`,
      period
    };
  }

  // Track current runs for incremental updates
  let currentRuns = new Map();

  // Create a table row for a run
  function createRunRow(run) {
    const info = formatRunInfo(run.earliest, run.latest);
    const lastActivity = formatTimeAgo(run.latest);
    const colorClasses = getColorClasses(info.period);

    const tr = document.createElement('tr');
    tr.dataset.runId = run.runId;
    tr.dataset.latest = run.latest || '';
    tr.dataset.count = run.count;
    tr.className = `${colorClasses} hover:opacity-80 transition cursor-pointer`;
    tr.onclick = () => window.location.href = `/?run_id=${encodeURIComponent(run.runId)}&run_name=${encodeURIComponent(run.runName)}`;

    const redDot = lastActivity.isRecent
      ? '<span class="inline-block w-2 h-2 bg-red-500 rounded-full mr-1.5 animate-pulse" title="Active in last 15 minutes"></span>'
      : '';

    tr.innerHTML = `
      <td class="px-3 py-1.5 text-xs font-medium text-gray-900 dark:text-gray-100">
        ${redDot}${run.runName}
      </td>
      <td class="px-3 py-1.5 text-xs text-gray-700 dark:text-gray-300">
        ${info.date}
      </td>
      <td class="px-3 py-1.5 text-xs text-gray-700 dark:text-gray-300">
        ${lastActivity.text}
      </td>
      <td class="px-3 py-1.5 text-xs text-right text-gray-700 dark:text-gray-300">
        ${run.count}
      </td>
      <td class="px-3 py-1.5 text-xs text-right text-gray-700 dark:text-gray-300">
        ${info.duration}
      </td>
    `;

    return tr;
  }

  // Update runs table incrementally
  function updateRuns(data) {
    if (!data.runs || Object.keys(data.runs).length === 0) {
      runContainer.classList.add('hidden');
      noRuns.classList.remove('hidden');
      runList.innerHTML = '';
      currentRuns.clear();
      return;
    }

    runContainer.classList.remove('hidden');
    noRuns.classList.add('hidden');
    runCount.textContent = Object.keys(data.runs).length;

    // Collect all runs into a flat array
    const allRuns = [];
    Object.keys(data.runs).forEach(runName => {
      const runData = data.runs[runName];
      runData.run_ids.forEach(runIdInfo => {
        allRuns.push({
          runName: runName,
          runId: runIdInfo.run_id,
          count: runIdInfo.count,
          earliest: runIdInfo.earliest,
          latest: runIdInfo.latest
        });
      });
    });

    // Sort by time (newest first)
    allRuns.sort((a, b) => {
      const timeA = a.earliest ? new Date(a.earliest) : new Date(0);
      const timeB = b.earliest ? new Date(b.earliest) : new Date(0);
      return timeB - timeA;
    });

    totalRuns.textContent = allRuns.length;

    // Build a map of new runs
    const newRuns = new Map(allRuns.map(run => [run.runId, run]));

    // Remove rows that no longer exist
    currentRuns.forEach((run, runId) => {
      if (!newRuns.has(runId)) {
        const row = runList.querySelector(`tr[data-run-id="${runId}"]`);
        if (row) row.remove();
        currentRuns.delete(runId);
      }
    });

    // Update existing rows and add new ones
    allRuns.forEach((run, index) => {
      const existingRow = runList.querySelector(`tr[data-run-id="${run.runId}"]`);

      if (existingRow) {
        // Check if data changed
        const oldRun = currentRuns.get(run.runId);
        if (oldRun && (oldRun.latest !== run.latest || oldRun.count !== run.count)) {
          // Replace with updated row
          const newRow = createRunRow(run);
          existingRow.replaceWith(newRow);
        } else {
          // Just update time ago display
          const info = formatRunInfo(run.earliest, run.latest);
          const lastActivity = formatTimeAgo(run.latest);
          const cells = existingRow.querySelectorAll('td');
          if (cells[2]) cells[2].textContent = lastActivity.text;
          if (cells[4]) cells[4].textContent = info.duration;

          // Update red dot status
          const firstCell = cells[0];
          const hasRedDot = firstCell.querySelector('.animate-pulse');
          if (lastActivity.isRecent && !hasRedDot) {
            firstCell.innerHTML = `<span class="inline-block w-2 h-2 bg-red-500 rounded-full mr-1.5 animate-pulse" title="Active in last 15 minutes"></span>${run.runName}`;
          } else if (!lastActivity.isRecent && hasRedDot) {
            firstCell.textContent = run.runName;
          }
        }

        // Ensure correct position in sorted order
        const currentIndex = Array.from(runList.children).indexOf(existingRow);
        if (currentIndex !== index) {
          if (index === 0) {
            runList.prepend(existingRow);
          } else {
            runList.children[index - 1].after(existingRow);
          }
        }
      } else {
        // Insert new row at correct position
        const newRow = createRunRow(run);
        if (index === 0) {
          runList.prepend(newRow);
        } else if (runList.children[index]) {
          runList.children[index].before(newRow);
        } else {
          runList.appendChild(newRow);
        }
      }

      currentRuns.set(run.runId, run);
    });
  }

  // Fetch runs from server
  function fetchRuns() {
    return fetch('/api/runs')
      .then(response => response.json())
      .then(data => {
        loading.classList.add('hidden');
        updateRuns(data);
      })
      .catch(error => {
        loading.classList.add('hidden');
        noRuns.classList.remove('hidden');
        console.error('Error fetching runs:', error);
      });
  }

  // Initial fetch
  fetchRuns();

  // Auto-refresh every 10 seconds
  setInterval(fetchRuns, 10000);
  </script>
</body>
</html>
